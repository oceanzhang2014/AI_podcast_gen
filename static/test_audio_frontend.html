<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Frontend Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-4">
        <h1>Audio Frontend Test</h1>
        <p>测试音频播放和下载功能修复</p>

        <div class="card mt-4">
            <div class="card-header">
                <h5>Audio Player Test</h5>
            </div>
            <div class="card-body">
                <!-- Audio Player -->
                <div class="audio-player-container mb-3">
                    <div class="card bg-light">
                        <div class="card-body">
                            <audio controls class="w-100" id="audioPlayer" preload="metadata">
                                <source src="#" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                            <div class="text-center mt-2">
                                <button class="btn btn-sm btn-outline-secondary" id="copyLinkBtn" type="button">
                                    <i class="bi bi-link-45deg me-1"></i>Copy Link
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" id="shareBtn" type="button">
                                    <i class="bi bi-share me-1"></i>Share
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5>Download Test</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="#" class="btn btn-success btn-lg" id="downloadBtn" download="">
                        <i class="bi bi-download me-2"></i>Download MP3
                    </a>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5>Test Controls</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary" onclick="testAudioFix()">Test Audio Fix</button>
                <button class="btn btn-info" onclick="testDownloadFix()">Test Download Fix</button>
                <button class="btn btn-warning" onclick="simulateError()">Simulate Error</button>
                <button class="btn btn-secondary" onclick="clearResults()">Clear Results</button>
            </div>
        </div>

        <div id="results" class="mt-4"></div>
    </div>

    <script>
        // 模拟AppState和Elements
        const AppState = {
            audioUrl: null,
            downloadUrl: null
        };

        const Elements = {
            audioPlayer: document.getElementById('audioPlayer'),
            downloadBtn: document.getElementById('downloadBtn')
        };

        // 测试音频文件
        const testAudioFile = 'podcast_20251019_094511.mp3';
        const baseUrl = 'http://127.0.0.1:5000';

        // 复制我们修复的函数
        async function validateAndSetupAudio(audioUrl) {
            try {
                log('验证音频文件: ' + audioUrl, 'info');

                // Show loading state
                showNotification('Validating audio file...', 'info');

                // Validate audio file accessibility
                const response = await fetch(audioUrl, { method: 'HEAD' });

                if (!response.ok) {
                    throw new Error(`Audio file not accessible (HTTP ${response.status})`);
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('audio/')) {
                    console.warn('Unexpected content type:', contentType);
                }

                // Update audio player
                if (Elements.audioPlayer) {
                    Elements.audioPlayer.src = audioUrl;
                    Elements.audioPlayer.load(); // Preload audio metadata

                    // Setup enhanced error handling
                    Elements.audioPlayer.addEventListener('error', handleAudioError);
                }

                // Update download button
                if (Elements.downloadBtn) {
                    Elements.downloadBtn.href = AppState.downloadUrl;
                    // Set proper download filename
                    const filename = generateFilename();
                    Elements.downloadBtn.setAttribute('download', filename);
                }

                showNotification('Audio file ready!', 'success');
                log('音频文件设置成功: ' + audioUrl, 'success');

            } catch (error) {
                console.error('Audio validation failed:', error);
                handleAudioError(error);
            }
        }

        function handleAudioError(error) {
            console.error('Audio playback error:', error);
            log('音频错误: ' + error.message, 'error');

            showNotification('Unable to load audio file. Please try again.', 'error');

            // Disable audio player
            if (Elements.audioPlayer) {
                Elements.audioPlayer.src = '';
                Elements.audioPlayer.style.display = 'none';
            }

            // Update download button state
            if (Elements.downloadBtn) {
                Elements.downloadBtn.href = '#';
                Elements.downloadBtn.classList.add('disabled');
            }

            // Show retry option
            showRetryOption();
        }

        function showRetryOption() {
            const resultsDiv = document.getElementById('results');
            const retryHtml = `
                <div class="alert alert-warning mt-3" id="audio-retry-section">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Audio loading failed</strong>
                    <p class="mb-2 mt-2">The audio file could not be loaded. This might be a temporary issue.</p>
                    <button class="btn btn-sm btn-warning" onclick="retryAudioLoading()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Retry Loading
                    </button>
                </div>
            `;

            // Remove existing retry section if present
            const existingRetry = document.getElementById('audio-retry-section');
            if (existingRetry) {
                existingRetry.remove();
            }

            // Add retry section
            resultsDiv.insertAdjacentHTML('beforeend', retryHtml);
        }

        async function retryAudioLoading() {
            // Remove retry section
            const retrySection = document.getElementById('audio-retry-section');
            if (retrySection) {
                retrySection.remove();
            }

            // Show audio player again
            if (Elements.audioPlayer) {
                Elements.audioPlayer.style.display = 'block';
            }

            // Re-enable download button
            if (Elements.downloadBtn) {
                Elements.downloadBtn.classList.remove('disabled');
            }

            // Retry validation
            await validateAndSetupAudio(AppState.audioUrl);
        }

        async function handleDownload() {
            if (!AppState.downloadUrl) {
                showNotification('No audio file available for download', 'error');
                return;
            }

            try {
                showNotification('Preparing download...', 'info');
                log('准备下载: ' + AppState.downloadUrl, 'info');

                // Validate download URL before initiating download
                const response = await fetch(AppState.downloadUrl, { method: 'HEAD' });

                if (!response.ok) {
                    throw new Error(`Download file not accessible (HTTP ${response.status})`);
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('audio/')) {
                    console.warn('Download file has unexpected content type:', contentType);
                }

                // Create a temporary link for download
                const link = document.createElement('a');
                link.href = AppState.downloadUrl;
                link.download = generateFilename();
                link.style.display = 'none';

                // Set proper download attributes
                const contentDisposition = response.headers.get('content-disposition');
                if (contentDisposition && contentDisposition.includes('filename=')) {
                    const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                    if (filenameMatch && filenameMatch[1]) {
                        link.download = filenameMatch[1].replace(/['"]/g, '');
                    }
                }

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showNotification('Download started!', 'success');
                log('下载开始成功', 'success');

            } catch (error) {
                console.error('Download error:', error);
                showNotification('Download failed. Please try again.', 'error');
                log('下载失败: ' + error.message, 'error');

                // Offer retry option
                showDownloadRetryOption();
            }
        }

        function showDownloadRetryOption() {
            const resultsDiv = document.getElementById('results');
            const retryHtml = `
                <div class="alert alert-warning mt-3" id="download-retry-section">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Download failed</strong>
                    <p class="mb-2 mt-2">The audio file could not be downloaded. This might be a temporary issue.</p>
                    <button class="btn btn-sm btn-warning" onclick="retryDownload()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Retry Download
                    </button>
                </div>
            `;

            // Remove existing download retry section if present
            const existingRetry = document.getElementById('download-retry-section');
            if (existingRetry) {
                existingRetry.remove();
            }

            // Add retry section
            resultsDiv.insertAdjacentHTML('beforeend', retryHtml);
        }

        async function retryDownload() {
            // Remove retry section
            const retrySection = document.getElementById('download-retry-section');
            if (retrySection) {
                retrySection.remove();
            }

            // Retry download
            await handleDownload();
        }

        function generateFilename() {
            const topic = 'test-podcast';
            const timestamp = new Date().toISOString().slice(0, 10);
            return `${topic}-${timestamp}.mp3`;
        }

        function showNotification(message, type) {
            log('通知: ' + message, type);
        }

        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const alertClass = type === 'error' ? 'alert-danger' :
                              type === 'success' ? 'alert-success' :
                              type === 'warning' ? 'alert-warning' : 'alert-info';

            const logEntry = `<div class="alert ${alertClass} mt-2">${message}</div>`;
            resultsDiv.insertAdjacentHTML('beforeend', logEntry);
        }

        // 测试函数
        async function testAudioFix() {
            AppState.audioUrl = `${baseUrl}/audio/${testAudioFile}`;
            AppState.downloadUrl = `${baseUrl}/download/${testAudioFile}`;

            await validateAndSetupAudio(AppState.audioUrl);
        }

        async function testDownloadFix() {
            AppState.downloadUrl = `${baseUrl}/download/${testAudioFile}`;

            await handleDownload();
        }

        function simulateError() {
            AppState.audioUrl = `${baseUrl}/audio/nonexistent-file.mp3`;
            AppState.downloadUrl = `${baseUrl}/download/nonexistent-file.mp3`;

            validateAndSetupAudio(AppState.audioUrl);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // 设置下载按钮事件
        Elements.downloadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            handleDownload();
        });

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('音频前端测试页面已加载', 'info');
            log('点击测试按钮来测试修复功能', 'info');
        });
    </script>
</body>
</html>