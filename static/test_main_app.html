<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main App Audio Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .test-button { margin: 10px; }
        .audio-item { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .audio-item audio { width: 100%; margin: 10px 0; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>主应用音频功能测试</h1>
        <p class="lead">测试主应用中的音频播放和下载功能</p>

        <div class="card mt-4">
            <div class="card-header">
                <h5>控制面板</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary test-button" onclick="loadAudioFiles()">
                    <i class="bi bi-list me-2"></i>加载音频文件列表
                </button>
                <button class="btn btn-success test-button" onclick="showExistingAudio()">
                    <i class="bi bi-play-circle me-2"></i>显示现有音频
                </button>
                <button class="btn btn-info test-button" onclick="simulatePodcastGeneration()">
                    <i class="bi bi-magic me-2"></i>模拟播客生成
                </button>
                <button class="btn btn-secondary test-button" onclick="clearAll()">
                    <i class="bi bi-trash me-2"></i>清除所有
                </button>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5>音频文件列表</h5>
            </div>
            <div class="card-body">
                <div id="audio-list">
                    <p class="text-muted">点击"加载音频文件列表"来获取可用的音频文件</p>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5>结果区域 (模拟主应用)</h5>
            </div>
            <div class="card-body">
                <div id="results-section" class="d-none">
                    <div class="alert alert-success mb-4">
                        <i class="bi bi-check-circle me-2"></i>
                        <strong>Success!</strong> Your podcast has been generated and is ready for preview and download.
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <h4 id="podcast-title">
                                <i class="bi bi-music-note-beamed me-2"></i>
                                <span>Generated Podcast</span>
                            </h4>
                            <p class="text-muted mb-3">
                                <i class="bi bi-clock me-1"></i>
                                Generated on: <span id="generation-timestamp">Just now</span>
                                <span class="ms-3" id="audio-duration"></span>
                            </p>

                            <!-- Audio Player -->
                            <div class="audio-player-container mb-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <audio controls class="w-100" id="audioPlayer" preload="metadata">
                                            <source src="#" type="audio/mpeg">
                                            Your browser does not support the audio element.
                                        </audio>
                                        <div class="text-center mt-2">
                                            <button class="btn btn-sm btn-outline-secondary" id="copyLinkBtn" type="button">
                                                <i class="bi bi-link-45deg me-1"></i>Copy Link
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" id="shareBtn" type="button">
                                                <i class="bi bi-share me-1"></i>Share
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid gap-2">
                                <a href="#" class="btn btn-success btn-lg" id="downloadBtn" download="">
                                    <i class="bi bi-download me-2"></i>Download MP3
                                </a>
                                <button class="btn btn-outline-primary" id="newPodcastBtn" type="button">
                                    <i class="bi bi-plus-circle me-2"></i>Create New Podcast
                                </button>
                            </div>

                            <!-- Additional Actions -->
                            <div class="mt-3">
                                <h6 class="fw-bold">Audio Details</h6>
                                <div class="small text-muted">
                                    <div>Format: MP3</div>
                                    <div>Quality: High (192 kbps)</div>
                                    <div id="file-size">Size: Calculating...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5>日志</h5>
            </div>
            <div class="card-body">
                <div id="log" class="log">
                    <div>等待操作...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 复制修复的函数
        const AppState = {
            audioUrl: null,
            downloadUrl: null
        };

        const Elements = {
            audioPlayer: document.getElementById('audioPlayer'),
            downloadBtn: document.getElementById('downloadBtn'),
            resultsSection: document.getElementById('results-section'),
            audioList: document.getElementById('audio-list'),
            log: document.getElementById('log')
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            Elements.log.textContent += logEntry;
            Elements.log.scrollTop = Elements.log.scrollHeight;
        }

        async function validateAndSetupAudio(audioUrl) {
            try {
                log('验证音频文件: ' + audioUrl, 'info');

                // Show loading state
                showNotification('Validating audio file...', 'info');

                // Validate audio file accessibility
                const response = await fetch(audioUrl, { method: 'HEAD' });

                if (!response.ok) {
                    throw new Error(`Audio file not accessible (HTTP ${response.status})`);
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('audio/')) {
                    console.warn('Unexpected content type:', contentType);
                }

                // Update audio player
                if (Elements.audioPlayer) {
                    Elements.audioPlayer.src = audioUrl;
                    Elements.audioPlayer.load(); // Preload audio metadata

                    // Setup enhanced error handling
                    Elements.audioPlayer.addEventListener('error', handleAudioError);
                }

                // Update download button
                if (Elements.downloadBtn) {
                    Elements.downloadBtn.href = AppState.downloadUrl;
                    // Set proper download filename
                    const filename = generateFilename();
                    Elements.downloadBtn.setAttribute('download', filename);
                }

                showNotification('Audio file ready!', 'success');
                log('音频文件设置成功: ' + audioUrl, 'success');

            } catch (error) {
                console.error('Audio validation failed:', error);
                handleAudioError(error);
            }
        }

        function handleAudioError(error) {
            console.error('Audio playback error:', error);
            log('音频错误: ' + error.message, 'error');

            showNotification('Unable to load audio file. Please try again.', 'error');

            // Disable audio player
            if (Elements.audioPlayer) {
                Elements.audioPlayer.src = '';
                Elements.audioPlayer.style.display = 'none';
            }

            // Update download button state
            if (Elements.downloadBtn) {
                Elements.downloadBtn.href = '#';
                Elements.downloadBtn.classList.add('disabled');
            }

            // Show retry option
            showRetryOption();
        }

        function showRetryOption() {
            const resultsDiv = Elements.resultsSection;
            const retryHtml = `
                <div class="alert alert-warning mt-3" id="audio-retry-section">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Audio loading failed</strong>
                    <p class="mb-2 mt-2">The audio file could not be loaded. This might be a temporary issue.</p>
                    <button class="btn btn-sm btn-warning" onclick="retryAudioLoading()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Retry Loading
                    </button>
                </div>
            `;

            // Remove existing retry section if present
            const existingRetry = document.getElementById('audio-retry-section');
            if (existingRetry) {
                existingRetry.remove();
            }

            // Add retry section
            resultsDiv.insertAdjacentHTML('beforeend', retryHtml);
        }

        async function retryAudioLoading() {
            // Remove retry section
            const retrySection = document.getElementById('audio-retry-section');
            if (retrySection) {
                retrySection.remove();
            }

            // Show audio player again
            if (Elements.audioPlayer) {
                Elements.audioPlayer.style.display = 'block';
            }

            // Re-enable download button
            if (Elements.downloadBtn) {
                Elements.downloadBtn.classList.remove('disabled');
            }

            // Retry validation
            await validateAndSetupAudio(AppState.audioUrl);
        }

        function generateFilename() {
            const topic = 'test-podcast';
            const timestamp = new Date().toISOString().slice(0, 10);
            return `${topic}-${timestamp}.mp3`;
        }

        function showNotification(message, type) {
            log('通知: ' + message, type);
        }

        async function loadAudioFiles() {
            try {
                log('正在加载音频文件列表...', 'info');
                const response = await fetch('http://127.0.0.1:5000/api/audio-files');
                const data = await response.json();

                if (data.success) {
                    displayAudioFiles(data.data.audio_files);
                    log(`成功加载 ${data.data.total_count} 个音频文件`, 'success');
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                log('加载音频文件失败: ' + error.message, 'error');
            }
        }

        function displayAudioFiles(audioFiles) {
            let html = '';
            audioFiles.forEach((file, index) => {
                html += `
                    <div class="audio-item">
                        <h6>${file.filename}</h6>
                        <p class="text-muted">
                            大小: ${formatFileSize(file.size)} |
                            类型: ${file.file_type} |
                            创建时间: ${new Date(file.created_at).toLocaleString()}
                        </p>
                        <audio controls class="w-100" id="test-audio-${index}">
                            <source src="${file.audio_url}" type="audio/${file.file_type}">
                            Your browser does not support the audio element.
                        </audio>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-primary" onclick="testAudioFile('${file.audio_url}', '${file.download_url}')">
                                <i class="bi bi-play-circle me-1"></i>测试播放
                            </button>
                            <button class="btn btn-sm btn-success" onclick="testDownloadFile('${file.download_url}', '${file.filename}')">
                                <i class="bi bi-download me-1"></i>测试下载
                            </button>
                        </div>
                    </div>
                `;
            });
            Elements.audioList.innerHTML = html;
        }

        async function testAudioFile(audioUrl, downloadUrl) {
            AppState.audioUrl = audioUrl;
            AppState.downloadUrl = downloadUrl;

            showResultsSection();
            await validateAndSetupAudio(audioUrl);
        }

        function testDownloadFile(downloadUrl, filename) {
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            log('开始下载: ' + filename, 'info');
        }

        function showResultsSection() {
            Elements.resultsSection.classList.remove('d-none');
            log('显示结果区域', 'info');
        }

        async function simulatePodcastGeneration() {
            log('模拟播客生成...', 'info');

            // 模拟播客生成的响应数据
            const mockResponse = {
                success: true,
                data: {
                    audio_url: '/audio/podcast_20251019_094511.mp3',
                    download_url: '/download/podcast_20251019_094511.mp3',
                    file_info: {
                        filename: 'podcast_20251019_094511.mp3',
                        size: 2708012,
                        created_at: new Date().toISOString()
                    }
                }
            };

            // 应用我们的修复逻辑
            if (mockResponse.data?.audio_url) {
                AppState.audioUrl = 'http://127.0.0.1:5000' + mockResponse.data.audio_url;
                AppState.downloadUrl = 'http://127.0.0.1:5000' + mockResponse.data.download_url;

                showResultsSection();
                await validateAndSetupAudio(AppState.audioUrl);

                // 更新文件大小显示
                if (mockResponse.data.file_info) {
                    document.getElementById('file-size').textContent =
                        `Size: ${formatFileSize(mockResponse.data.file_info.size)}`;
                }
            }
        }

        function showExistingAudio() {
            // 直接使用最新的音频文件
            AppState.audioUrl = 'http://127.0.0.1:5000/audio/podcast_20251019_094511.mp3';
            AppState.downloadUrl = 'http://127.0.0.1:5000/download/podcast_20251019_094511.mp3';

            showResultsSection();
            validateAndSetupAudio(AppState.audioUrl);

            document.getElementById('file-size').textContent = 'Size: 2.6 MB';
        }

        function clearAll() {
            Elements.resultsSection.classList.add('d-none');
            Elements.audioList.innerHTML = '<p class="text-muted">点击"加载音频文件列表"来获取可用的音频文件</p>';
            Elements.log.textContent = '日志已清除\n';
            AppState.audioUrl = null;
            AppState.downloadUrl = null;

            // 重置音频播放器
            if (Elements.audioPlayer) {
                Elements.audioPlayer.src = '#';
                Elements.audioPlayer.style.display = 'block';
            }

            // 重置下载按钮
            if (Elements.downloadBtn) {
                Elements.downloadBtn.href = '#';
                Elements.downloadBtn.classList.remove('disabled');
            }

            log('所有内容已清除', 'info');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 设置下载按钮事件
        Elements.downloadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (AppState.downloadUrl) {
                const link = document.createElement('a');
                link.href = AppState.downloadUrl;
                link.download = generateFilename();
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                log('下载开始: ' + generateFilename(), 'info');
            } else {
                log('没有可用的音频文件进行下载', 'error');
            }
        });

        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            log('主应用音频测试页面已加载', 'info');
            log('提示: 使用控制面板测试各种功能', 'info');
        });
    </script>
</body>
</html>