# æ–°å£°éŸ³åå¥½ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## æ¦‚è¿° ğŸ¯

ç³»ç»Ÿå·²å®Œæˆé‡å¤§å‡çº§ï¼Œç°åœ¨æ”¯æŒåŸºäº**é£æ ¼åˆ†ç±»**çš„å£°éŸ³é€‰æ‹©æ¨¡å¼ã€‚å‰ç«¯ç”¨æˆ·å¯ä»¥ï¼š

1. **å¹´é¾„é€‰æ‹©**ï¼šä» `voice_preferences.json` çš„ "å¹´é¾„é€‰é¡¹" ä¸­é€‰æ‹©
2. **å£°éŸ³åå¥½é€‰æ‹©**ï¼šä» "å£°éŸ³åå¥½" åˆ†ç±»ä¸­é€‰æ‹©
3. **ç²¾ç¡®åŒ¹é…**ï¼šé€šè¿‡ æ€§åˆ« + å¹´é¾„ + å£°éŸ³åå¥½ åœ¨ç§å­å¯¹ç…§è¡¨ä¸­åŒ¹é…å€™é€‰

## ğŸ¨ æ–°å‰ç«¯ç•Œé¢è®¾è®¡

### ç•Œé¢å¸ƒå±€å»ºè®®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è§’è‰²å£°éŸ³é…ç½®                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è§’è‰²åç§°: [è¾“å…¥æ¡†: å°æ˜]                                â”‚
â”‚ æ€§    åˆ«: [ä¸‹æ‹‰é€‰æ‹©: ç”·æ€§/å¥³æ€§]                          â”‚
â”‚ å¹´    é¾„: [ä¸‹æ‹‰é€‰æ‹©: å¹´è½»/ä¸­å¹´/å…¶ä»–]                     â”‚
â”‚ å£°éŸ³é£æ ¼: [åˆ†ç±»é€‰æ‹©: æ–‡å­¦é£æ ¼/æ¸©æŸ”é£æ ¼/...]               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŒ¹é…ç»“æœ: [æ˜¾ç¤ºåŒ¹é…çš„ç§å­å’Œæè¿°]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‰ç«¯é€‰æ‹©æµç¨‹

1. **æ€§åˆ«é€‰æ‹©** (ç”·æ€§/å¥³æ€§)
2. **å¹´é¾„é€‰æ‹©** (å¹´è½»/ä¸­å¹´/å…¶ä»–)
3. **é£æ ¼é€‰æ‹©** (ä»9ç§å£°éŸ³åå¥½åˆ†ç±»ä¸­é€‰æ‹©)
4. **è‡ªåŠ¨åŒ¹é…** ç³»ç»Ÿæ ¹æ® æ€§åˆ«+å¹´é¾„+é£æ ¼ ç²¾ç¡®åŒ¹é…ç§å­

## ğŸ“‹ å£°éŸ³åå¥½åˆ†ç±»

### å¯ç”¨é£æ ¼é€‰é¡¹

| é£æ ¼åˆ†ç±» | æè¿° | é€‚ç”¨æ€§åˆ« | é€‚ç”¨å¹´é¾„ |
|---------|------|----------|----------|
| **æ–‡å­¦é£æ ¼** | çŸ¥æ€§æ–‡é›…ï¼Œé€‚åˆæœ—è¯»æ–‡å­¦ä½œå“ | ç”·æ€§ | å¹´è½» |
| **æ¸©æŸ”é£æ ¼** | æ¸©å’ŒæŸ”è½¯ï¼Œäº²åˆ‡è‡ªç„¶ | ç”·æ€§ | å¹´è½» |
| **ä¸“ä¸šé£æ ¼** | ä¸“ä¸šç¨³é‡ï¼Œé€‚åˆæ­£å¼åœºåˆ | ç”·æ€§ | ä¸­å¹´ |
| **æ¸¯å¼é£æ ¼** | æ¸¯å¼å‘éŸ³ï¼Œç‹¬ç‰¹é­…åŠ› | ç”·æ€§ | ä¸­å¹´ |
| **æ·±æ²‰é£æ ¼** | ä½æ²‰æœ‰åŠ›ï¼Œæƒå¨æ„Ÿå¼º | ç”·æ€§ | ä¸­å¹´ |
| **æƒ…æ„Ÿé£æ ¼** | æƒ…æ„Ÿä¸°å¯Œï¼Œè¡¨ç°åŠ›å¼º | å¥³æ€§ | å¹´è½» |
| **æ·±æƒ…é£æ ¼** | æ·±æƒ…åŠ¨äººï¼Œæ¸©æš–æ„Ÿäºº | å¥³æ€§ | ä¸­å¹´ |
| **æ¸…æ¾ˆé£æ ¼** | æ¸…æ¾ˆçº¯å‡€ï¼Œæ¸…æ™°æ˜äº® | å¥³æ€§ | ä¸­å¹´ |
| **å¹³é™é£æ ¼** | å¹³é™å®é™ï¼Œå®‰è¯¦èˆ’é€‚ | å¥³æ€§ | ä¸­å¹´ |

## ğŸ”§ API æ¥å£ä½¿ç”¨

### 1. è·å–æ‰€æœ‰å£°éŸ³é€‰é¡¹

```javascript
// GET /api/all-voice-combinations
const response = await fetch('/api/all-voice-combinations');
const data = await response.json();

// å“åº”ç»“æ„
{
  "success": true,
  "data": {
    "å£°éŸ³åå¥½": {
      "æ–‡å­¦é£æ ¼": {
        "description": "çŸ¥æ€§æ–‡é›…ï¼Œé€‚åˆæœ—è¯»æ–‡å­¦ä½œå“",
        "é€‚ç”¨ç»„åˆ": [...]
      },
      // ... å…¶ä»–é£æ ¼
    },
    "æ€§åˆ«é€‰é¡¹": {"male": "ç”·æ€§", "female": "å¥³æ€§"},
    "å¹´é¾„é€‰é¡¹": {"å¹´è½»": "å¹´è½»", "ä¸­å¹´": "ä¸­å¹´", "å…¶ä»–": "å…¶ä»–"},
    "æ‰€æœ‰ç»„åˆ": [
      {
        "å¹´é¾„": "å¹´è½»",
        "å¹´é¾„æ˜¾ç¤º": "å¹´è½»",
        "é£æ ¼": "æ–‡å­¦é£æ ¼",
        "é£æ ¼æè¿°": "çŸ¥æ€§æ–‡é›…ï¼Œé€‚åˆæœ—è¯»æ–‡å­¦ä½œå“",
        "æ”¯æŒæ€§åˆ«": ["ç”·æ€§"],
        "å€™é€‰ç§å­": [{"ç§å­": "111", "æè¿°": "å¹´è½»ç”·æ€§ - æ–‡å­¦æ°”è´¨"}]
      },
      // ... å…¶ä»–ç»„åˆ
    ],
    "ç»Ÿè®¡ä¿¡æ¯": {
      "æ€»é£æ ¼æ•°": 9,
      "æ€»ç§å­æ•°": 9,
      "æ‰€æœ‰ç»„åˆæ•°": 9
    }
  }
}
```

### 2. ç”Ÿæˆè§’è‰²å£°éŸ³

```javascript
// POST /api/voice-seed
const response = await fetch('/api/voice-seed', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    gender: "ç”·æ€§",           // å‰ç«¯ä½¿ç”¨ä¸­æ–‡
    age: "å¹´è½»",             // å¹´é¾„é€‰é¡¹
    style: "æ–‡å­¦é£æ ¼",       // å£°éŸ³åå¥½åˆ†ç±»
    character_name: "å°æ˜"
  })
});

const result = await response.json();

// å“åº”ç¤ºä¾‹
{
  "success": true,
  "data": {
    "seed": "111",
    "description": "å¹´è½»ç”·æ€§ - æ–‡å­¦æ°”è´¨",
    "gender": "ç”·æ€§",        // å‰ç«¯å‹å¥½çš„ä¸­æ–‡æ ¼å¼
    "age": "å¹´è½»",
    "style": "æ–‡å­¦é£æ ¼",
    "character_name": "å°æ˜"
  }
}
```

## ğŸ¯ å‰ç«¯å®ç°ç¤ºä¾‹

### React ç»„ä»¶

```jsx
import React, { useState, useEffect } from 'react';

function VoicePreferenceSelector() {
  const [characterName, setCharacterName] = useState('');
  const [gender, setGender] = useState('ç”·æ€§');
  const [age, setAge] = useState('å¹´è½»');
  const [style, setStyle] = useState('');
  const [voiceData, setVoiceData] = useState(null);
  const [selectedSeed, setSelectedSeed] = useState(null);
  const [loading, setLoading] = useState(false);

  // åŠ è½½å£°éŸ³åå¥½æ•°æ®
  useEffect(() => {
    loadVoicePreferences();
  }, []);

  const loadVoicePreferences = async () => {
    try {
      const response = await fetch('/api/all-voice-combinations');
      const result = await response.json();
      if (result.success) {
        setVoiceData(result.data);
      }
    } catch (error) {
      console.error('Failed to load voice preferences:', error);
    }
  };

  // è·å–å¯ç”¨é£æ ¼é€‰é¡¹
  const getAvailableStyles = () => {
    if (!voiceData) return [];

    const allCombos = voiceData.æ‰€æœ‰ç»„åˆ || [];
    return allCombos
      .filter(combo =>
        combo.æ”¯æŒæ€§åˆ«.includes(gender) &&
        combo.å¹´é¾„æ˜¾ç¤º === age
      )
      .map(combo => ({
        style: combo.é£æ ¼,
        description: combo.é£æ ¼æè¿°,
        candidates: combo.å€™é€‰ç§å­
      }));
  };

  // ç”Ÿæˆå£°éŸ³
  const handleGenerateVoice = async () => {
    if (!characterName || !style) {
      alert('è¯·å¡«å†™è§’è‰²åç§°å¹¶é€‰æ‹©å£°éŸ³é£æ ¼');
      return;
    }

    setLoading(true);
    try {
      const response = await fetch('/api/voice-seed', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          gender,
          age,
          style,
          character_name: characterName
        })
      });

      const result = await response.json();
      if (result.success) {
        setSelectedSeed(result.data);
      } else {
        alert('ç”Ÿæˆå£°éŸ³å¤±è´¥');
      }
    } catch (error) {
      console.error('Voice generation failed:', error);
      alert('ç”Ÿæˆå£°éŸ³å¤±è´¥');
    } finally {
      setLoading(false);
    }
  };

  const availableStyles = getAvailableStyles();

  return (
    <div className="voice-preference-selector">
      <h2>è§’è‰²å£°éŸ³é…ç½®</h2>

      {/* åŸºæœ¬ä¿¡æ¯è¾“å…¥ */}
      <div className="form-section">
        <div className="form-group">
          <label>è§’è‰²åç§°:</label>
          <input
            type="text"
            value={characterName}
            onChange={(e) => setCharacterName(e.target.value)}
            placeholder="è¯·è¾“å…¥è§’è‰²åç§°"
          />
        </div>

        <div className="form-group">
          <label>æ€§åˆ«:</label>
          <select value={gender} onChange={(e) => setGender(e.target.value)}>
            <option value="ç”·æ€§">ç”·æ€§</option>
            <option value="å¥³æ€§">å¥³æ€§</option>
          </select>
        </div>

        <div className="form-group">
          <label>å¹´é¾„:</label>
          <select value={age} onChange={(e) => setAge(e.target.value)}>
            {voiceData?.å¹´é¾„é€‰é¡¹ && Object.entries(voiceData.å¹´é¾„é€‰é¡¹).map(([key, value]) => (
              <option key={key} value={value}>{value}</option>
            ))}
          </select>
        </div>
      </div>

      {/* å£°éŸ³é£æ ¼é€‰æ‹© */}
      <div className="style-section">
        <h3>å£°éŸ³é£æ ¼é€‰æ‹©</h3>
        <div className="style-grid">
          {availableStyles.map((styleOption) => (
            <div
              key={styleOption.style}
              className={`style-card ${style === styleOption.style ? 'selected' : ''}`}
              onClick={() => setStyle(styleOption.style)}
            >
              <h4>{styleOption.style}</h4>
              <p>{styleOption.description}</p>
              <small>å¯é€‰ç§å­: {styleOption.candidates.length}ä¸ª</small>
            </div>
          ))}
        </div>

        {availableStyles.length === 0 && (
          <p className="no-styles">æš‚æ— å¯ç”¨çš„å£°éŸ³é£æ ¼é€‰é¡¹</p>
        )}
      </div>

      {/* ç”ŸæˆæŒ‰é’® */}
      <div className="action-section">
        <button
          onClick={handleGenerateVoice}
          disabled={!characterName || !style || loading}
          className="generate-btn"
        >
          {loading ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆå£°éŸ³'}
        </button>
      </div>

      {/* ç»“æœæ˜¾ç¤º */}
      {selectedSeed && (
        <div className="result-section">
          <h3>ç”Ÿæˆç»“æœ</h3>
          <div className="result-card">
            <p><strong>è§’è‰²:</strong> {selectedSeed.character_name}</p>
            <p><strong>ç§å­:</strong> {selectedSeed.seed}</p>
            <p><strong>æ€§åˆ«:</strong> {selectedSeed.gender}</p>
            <p><strong>å¹´é¾„:</strong> {selectedSeed.age}</p>
            <p><strong>é£æ ¼:</strong> {selectedSeed.style}</p>
            <p><strong>æè¿°:</strong> {selectedSeed.description}</p>
          </div>
        </div>
      )}
    </div>
  );
}

export default VoicePreferenceSelector;
```

## ğŸ”„ ç³»ç»Ÿå·¥ä½œæµç¨‹

### å®Œæ•´åŒ¹é…æµç¨‹

```
ç”¨æˆ·é€‰æ‹©: ç”·æ€§ + å¹´è½» + æ–‡å­¦é£æ ¼
    â†“
ç³»ç»ŸæŸ¥æ‰¾: voice_preferences.json ç§å­å¯¹ç…§è¡¨
    â†“
ç²¾ç¡®åŒ¹é…: gender="male", age="å¹´è½»", style="æ–‡å­¦é£æ ¼"
    â†“
æ‰¾åˆ°ç§å­: seed="111", description="å¹´è½»ç”·æ€§ - æ–‡å­¦æ°”è´¨"
    â†“
è¿”å›ç»“æœ: ç§å­111 åŠæè¿°ä¿¡æ¯
```

### æ•°æ®æµç¨‹å›¾

```
voice_preferences.json
    â”œâ”€â”€ å£°éŸ³åå¥½ (åˆ†ç±»æè¿°)
    â”œâ”€â”€ æ€§åˆ«é€‰é¡¹ (å‰ç«¯æ˜¾ç¤ºæ˜ å°„)
    â”œâ”€â”€ å¹´é¾„é€‰é¡¹ (å‰ç«¯æ˜¾ç¤ºæ˜ å°„)
    â””â”€â”€ ç§å­å¯¹ç…§è¡¨ (ç²¾ç¡®åŒ¹é…æ•°æ®)
            â†“
    chattts_engine.py
    â”œâ”€â”€ get_voice_preferences_for_frontend()
    â”œâ”€â”€ get_candidates_by_preference()
    â””â”€â”€ _find_seed_from_preferences()
            â†“
    app.py
    â”œâ”€â”€ map_frontend_gender_to_backend()
    â””â”€â”€ map_backend_gender_to_frontend()
            â†“
    å‰ç«¯ç•Œé¢
    â”œâ”€â”€ ä¸­æ–‡åŒ–æ˜¾ç¤º
    â”œâ”€â”€ åˆ†ç±»é€‰æ‹©
    â””â”€â”€ å®æ—¶åŒ¹é…
```

## ğŸ“Š æ•°æ®ç»“æ„è¯¦è§£

### å‰ç«¯æ•°æ®ç»“æ„

```json
{
  "å£°éŸ³åå¥½": {
    "é£æ ¼åç§°": {
      "description": "é£æ ¼æè¿°",
      "é€‚ç”¨ç»„åˆ": [
        {
          "æ€§åˆ«": "male/female",
          "æ€§åˆ«æ˜¾ç¤º": "ç”·æ€§/å¥³æ€§",
          "å¹´é¾„": "å¹´è½»/ä¸­å¹´/å…¶ä»–",
          "å¹´é¾„æ˜¾ç¤º": "å¹´è½»/ä¸­å¹´/å…¶ä»–",
          "å€™é€‰ç§å­": [
            {
              "ç§å­": "ç§å­ç¼–å·",
              "æè¿°": "ç§å­æè¿°"
            }
          ]
        }
      ]
    }
  },
  "æ‰€æœ‰ç»„åˆ": [
    {
      "å¹´é¾„": "å¹´é¾„å€¼",
      "å¹´é¾„æ˜¾ç¤º": "å¹´é¾„æ˜¾ç¤ºå€¼",
      "é£æ ¼": "é£æ ¼åç§°",
      "é£æ ¼æè¿°": "é£æ ¼æè¿°",
      "æ”¯æŒæ€§åˆ«": ["æ€§åˆ«æ˜¾ç¤º1", "æ€§åˆ«æ˜¾ç¤º2"],
      "å€™é€‰ç§å­": [...]
    }
  ]
}
```

## âœ¨ ç³»ç»Ÿä¼˜åŠ¿

1. **ç”¨æˆ·å‹å¥½**
   - å®Œå…¨ä¸­æ–‡åŒ–ç•Œé¢
   - ç›´è§‚çš„åˆ†ç±»é€‰æ‹©
   - æ¸…æ™°çš„æè¿°ä¿¡æ¯

2. **ç²¾ç¡®åŒ¹é…**
   - æ€§åˆ« + å¹´é¾„ + é£æ ¼ä¸‰é‡åŒ¹é…
   - åŸºäºJSONé…ç½®çš„ç§å­ç®¡ç†
   - ä¸€è‡´æ€§ä¿è¯

3. **çµæ´»æ‰©å±•**
   - æ˜“äºæ·»åŠ æ–°é£æ ¼
   - æ”¯æŒå¤šç§å­å€™é€‰
   - é…ç½®é©±åŠ¨çš„è®¾è®¡

4. **å‰åç«¯åˆ†ç¦»**
   - ä¸­æ–‡æ€§åˆ«æ˜ å°„
   - RESTful APIè®¾è®¡
   - å‰ç«¯å‹å¥½çš„æ•°æ®æ ¼å¼

## ğŸš€ å¿«é€Ÿå¼€å§‹

1. **æŸ¥çœ‹å¯ç”¨é€‰é¡¹**
   ```bash
   curl http://localhost:5000/api/all-voice-combinations
   ```

2. **åˆ›å»ºè§’è‰²å£°éŸ³**
   ```bash
   curl -X POST http://localhost:5000/api/voice-seed \
     -H "Content-Type: application/json" \
     -d '{
       "gender": "ç”·æ€§",
       "age": "å¹´è½»",
       "style": "æ–‡å­¦é£æ ¼",
       "character_name": "å°æ˜"
     }'
   ```

3. **è¿è¡Œæµ‹è¯•éªŒè¯**
   ```bash
   python test_new_voice_preference_system.py
   ```

## ğŸ“ æ›´æ–°æ—¥å¿—

### v2.0.0 - é£æ ¼åˆ†ç±»ç³»ç»Ÿ
- âœ… å®ç°åŸºäºé£æ ¼åˆ†ç±»çš„å£°éŸ³é€‰æ‹©
- âœ… æ”¯æŒå¹´é¾„é€‰æ‹©åŠŸèƒ½
- âœ… å®Œå–„æ€§åˆ«+å¹´é¾„+é£æ ¼ç²¾ç¡®åŒ¹é…
- âœ… å‰ç«¯ä¸­æ–‡åŒ–æ”¯æŒ
- âœ… æ–°å¢æµ‹è¯•éªŒè¯è„šæœ¬

### v1.0.0 - åŸºç¡€ç³»ç»Ÿ
- âœ… ChatTTSå¼•æ“é›†æˆ
- âœ… åŸºç¡€ç§å­é€‰æ‹©
- âœ… JSONé…ç½®æ”¯æŒ

---

ç°åœ¨å‰ç«¯ç”¨æˆ·å¯ä»¥äº«å—åŸºäºé£æ ¼åˆ†ç±»çš„ç›´è§‚å£°éŸ³é€‰æ‹©ä½“éªŒï¼ğŸ‰